<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Lab: Cumulative Proof (History Mode)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap');

        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --accent-purple: #a855f7;
            --success: #10b981;
            --success-bg: #d1fae5;
            --danger: #ef4444;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- MAIN APP SHELL --- */
        #app-shell {
            width: 95%;
            height: 90%;
            max-width: 1100px;
            background: var(--bg-color);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        /* --- TOP BAR --- */
        .nav-bar {
            height: 70px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            flex-shrink: 0;
            z-index: 10;
        }
        .nav-title { 
            font-family: 'Fredoka', sans-serif; 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sound-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; }
        .sound-btn:hover { transform: scale(1.1); }

        /* --- CONTENT CONTAINER --- */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* --- LEFT: SCROLLABLE FEED (Visual Stage) --- */
        .feed-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            padding: 20px 30px;
            overflow-y: auto;
            scroll-behavior: smooth;
            background: #f1f5f9;
            mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
        }

        /* The Card for each step */
        .step-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            transform-origin: center bottom;
            animation: slideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: all 0.3s ease;
            opacity: 0.8; 
        }

        .step-card.active {
            border-color: var(--primary);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.15);
            transform: scale(1.02);
            opacity: 1;
            z-index: 2;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .step-math {
            font-family: 'Fredoka', sans-serif;
            font-size: clamp(1.8rem, 2.5vw, 2.2rem);
            color: var(--text-main);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }

        .step-explanation {
            background: #f8fafc;
            color: #475569;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 1.05rem;
            line-height: 1.5;
            border-left: 4px solid var(--primary-light);
        }
        
        /* Special style for conclusion */
        .step-card.conclusion {
            background: #fef2f2;
            border-color: var(--danger);
        }
        .step-card.conclusion .step-explanation {
            background: #fff;
            border-left-color: var(--danger);
            color: #991b1b;
        }

        /* Style for RATIONAL number */
        .step-card.rational-card {
            background: #f0fdf4;
            border-color: var(--success);
        }
        .step-card.rational-card .step-explanation {
            background: #fff;
            border-left-color: var(--success);
            color: #065f46;
        }
        .step-card.rational-card .step-math {
            color: var(--success);
        }

        .feed-spacer { min-height: 50px; }

        /* Math Components */
        .cube {
            padding: 4px 12px;
            border-radius: 8px;
            color: white;
            display: inline-block;
            box-shadow: 0 3px 0 rgba(0,0,0,0.15);
            font-weight: 600;
            font-size: 0.9em;
        }
        .cube-a { background: var(--accent-pink); }
        .cube-b { background: var(--accent-orange); }
        .cube-c { background: var(--accent-purple); }

        .fraction-stack {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 8px;
        }
        .fraction-bar {
            width: 100%;
            height: 3px;
            background: var(--text-main);
            border-radius: 5px;
            margin: 4px 0;
        }

        .highlight-box {
            animation: pop 0.4s ease-out;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
            border-radius: 8px;
        }

        /* --- RIGHT: CONTROLS --- */
        .control-panel {
            flex: 1;
            background: #ffffff;
            border-left: 1px solid #e2e8f0;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            z-index: 5;
        }

        .panel-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
        }

        .input-label {
            display: block;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .num-input {
            width: 80px;
            padding: 10px;
            text-align: center;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Fredoka', sans-serif;
            transition: all 0.2s;
        }
        .num-input:focus { outline: none; border-color: var(--primary); }
        .num-input.error { border-color: var(--danger); animation: shake 0.4s; }

        .lock-badge {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
            background: #d1fae5;
            color: #059669;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .lock-badge.broken { background: #fee2e2; color: #dc2626; }
        .lock-badge.rational { background: #dcfce7; color: #166534; border: 1px solid #166534; }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: auto;
        }

        .btn-main {
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px;
            font-size: 1.1rem;
            border-radius: 12px;
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 0 #3730a3;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #3730a3; }
        .btn-main:disabled { background: #94a3b8; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.7; }
        
        .btn-reset {
            background: transparent;
            border: 2px solid #e2e8f0;
            color: var(--text-muted);
            padding: 12px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-reset:hover { border-color: var(--danger); color: var(--danger); background: #fef2f2; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .msg-toast {
            font-size: 0.85rem;
            color: var(--danger);
            min-height: 1.2em;
            margin-top: 5px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

        /* Mobile Responsive */
        @media (max-width: 800px) {
            .main-content { flex-direction: column-reverse; }
            .control-panel { border-left: none; border-bottom: 1px solid #e2e8f0; padding: 20px; flex: none; }
            .feed-area { padding: 15px; }
            .step-math { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<div id="app-shell">
    <div class="nav-bar">
        <div class="nav-title">
            <span>âš¡</span> Proof Lab
        </div>
        <button class="sound-btn" id="muteBtn" onclick="toggleMute()" title="Toggle Sound">ðŸ”Š</button>
    </div>

    <div class="main-content">
        <div class="feed-area" id="feedArea">
            <div id="stepsContainer"></div>
            <div class="feed-spacer"></div>
        </div>

        <div class="control-panel">
            <div class="panel-card">
                <label class="input-label">NUMBER EXPLORER (âˆšn)</label>
                <div class="input-wrapper">
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-family:'Fredoka'; font-size:1.5rem; margin-right:10px;">n =</span>
                        <div id="errorMsg" class="msg-toast">Must be square-free!</div>
                    </div>
                    <input type="number" id="nInput" class="num-input" value="2" min="2" max="144" onchange="validateAndReset()">
                </div>
            </div>

            <div class="lock-badge" id="lockUI">ðŸ”’ Coprime Assumption</div>

            <div class="progress-bar">
                <div id="progressBar" class="progress-fill"></div>
            </div>

            <div class="btn-group">
                <button class="btn-main" id="nextBtn" onclick="nextStep()">
                    <span>Next Step</span> â¬‡
                </button>
                <button class="btn-reset" onclick="hardReset()">â†º Start Over</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- AUDIO SYSTEM ---
    const AudioSys = {
        ctx: null,
        muted: false,
        init() {
            if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            if(this.ctx.state === 'suspended') this.ctx.resume();
        },
        playTone(freq, type, dur, vol = 0.1) {
            if(this.muted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + dur);
        },
        // SFX Palette
        click: () => AudioSys.playTone(400, 'sine', 0.15, 0.05),
        pop: () => AudioSys.playTone(600, 'triangle', 0.1, 0.05),
        success: () => { 
            setTimeout(()=>AudioSys.playTone(523.25, 'sine', 0.3), 0);
            setTimeout(()=>AudioSys.playTone(659.25, 'sine', 0.4), 100); 
        },
        error: () => { 
            AudioSys.playTone(150, 'sawtooth', 0.3, 0.08); 
            setTimeout(()=>AudioSys.playTone(110, 'sawtooth', 0.3, 0.08), 150); 
        },
        alert: () => AudioSys.playTone(300, 'square', 0.1, 0.05)
    };

    function toggleMute() {
        AudioSys.muted = !AudioSys.muted;
        document.getElementById('muteBtn').innerText = AudioSys.muted ? 'ðŸ”‡' : 'ðŸ”Š';
    }

    // --- MATH & LOGIC ---
    let state = { step: 0, n: 2 };
    const STEPS_TOTAL = 10;
    
    // Safety Check: We only want Square-Free numbers for the IRRATIONAL proof
    function isSquareFree(n) {
        if (n < 2) return false;
        // Perfect squares are NOT square free, but we handle them separately now
        for (let i = 2; i * i <= n; i++) {
            if (n % (i * i) === 0) return false;
        }
        return true;
    }

    const dom = {
        container: document.getElementById('stepsContainer'),
        feed: document.getElementById('feedArea'),
        input: document.getElementById('nInput'),
        lock: document.getElementById('lockUI'),
        nextBtn: document.getElementById('nextBtn'),
        bar: document.getElementById('progressBar'),
        error: document.getElementById('errorMsg')
    };

    function validateAndReset() {
        let val = parseInt(dom.input.value);
        if(isNaN(val)) val = 2;
        if(val < 1) val = 1;

        dom.error.style.opacity = '0';
        dom.input.classList.remove('error');

        // --- NEW LOGIC START ---
        
        // 1. Check for Perfect Square (Rational)
        const root = Math.sqrt(val);
        if (Number.isInteger(root)) {
            showRationalProof(val, root);
            return;
        }

        // 2. Check for Non-Square-Free Composite (like 12, 18)
        // These are irrational, but the specific "divisibility" proof provided is complex for them
        // so we reject them to keep the math clean for the student.
        if (!isSquareFree(val)) {
            dom.input.classList.add('error');
            dom.error.style.opacity = '1';
            AudioSys.error();
            
            // Suggest safe number
            let safe = val + 1;
            while(!isSquareFree(safe) || Number.isInteger(Math.sqrt(safe))) safe++;
            dom.error.innerText = `Try ${safe} instead?`;
            return;
        }

        // 3. Valid Square-Free Integer -> Proceed with Contradiction Proof
        resetProof(val);
        // --- NEW LOGIC END ---
    }

    function hardReset() {
        AudioSys.click();
        validateAndReset();
    }

    // NEW FUNCTION: Handles Rational Numbers
    function showRationalProof(n, root) {
        AudioSys.init();
        
        // Clear UI
        dom.container.innerHTML = '';
        dom.nextBtn.disabled = true;
        dom.nextBtn.innerHTML = "Rational Number";
        
        // Update Badge
        dom.lock.className = 'lock-badge rational';
        dom.lock.innerHTML = 'âœ… RATIONAL';
        
        dom.bar.style.width = '100%';
        dom.error.style.opacity = '0';
        dom.input.classList.remove('error');

        // Create the Rational Card
        const card = document.createElement('div');
        card.className = `step-card active rational-card`;
        card.innerHTML = `
            <div class="step-header">Calculation Complete</div>
            <div class="step-math">âˆš${n} &nbsp;=&nbsp; ${root}</div>
            <div class="step-explanation">
                <strong>It's a Perfect Square!</strong><br><br>
                Since ${n} is a perfect square, its square root is exactly <strong>${root}</strong>.<br>
                Because ${root} can be written as the fraction ${root}/1, it is a <strong>Rational Number</strong>.
                <br><br>
                No proof by contradiction is needed.
            </div>
        `;

        dom.container.appendChild(card);
        AudioSys.success();
    }

    function resetProof(nVal) {
        AudioSys.init();
        
        state.step = 0;
        state.n = nVal;
        
        // Clear UI
        dom.container.innerHTML = '';
        dom.nextBtn.disabled = false;
        dom.nextBtn.innerHTML = "<span>Next Step</span> â¬‡";
        dom.lock.className = 'lock-badge';
        dom.lock.innerHTML = 'ðŸ”’ Coprime Assumption';
        dom.bar.style.width = '0%';
        dom.error.style.opacity = '0';
        dom.input.classList.remove('error');

        addStepToDom();
    }

    function nextStep() {
        if(state.step < STEPS_TOTAL) {
            state.step++;
            AudioSys.pop();
            // Deactivate previous
            const cards = document.querySelectorAll('.step-card');
            cards.forEach(c => c.classList.remove('active'));
            
            addStepToDom();
        }
    }

    function addStepToDom() {
        const n = state.n;
        const root = Math.sqrt(n);

        // Pre-calculated templates
        const a = `<span class="cube cube-a">a</span>`;
        const b = `<span class="cube cube-b">b</span>`;
        const c = `<span class="cube cube-c">c</span>`;
        const frac = (t, bo) => `<div class="fraction-stack"><span>${t}</span><div class="fraction-bar"></div><span>${bo}</span></div>`;

        let mathHTML = '';
        let textHTML = '';
        let isConclusion = false;

        switch(state.step) {
            case 0:
                mathHTML = `âˆš${n} &nbsp;=&nbsp; ${frac(a, b)}`;
                textHTML = `<strong>Hypothesis:</strong> Assume âˆš${n} is rational. We write it as a fraction ${a}/${b} in <em>lowest terms</em> (coprime).`;
                break;
            case 1:
                mathHTML = `${n} &nbsp;=&nbsp; ${frac(a+'Â²', b+'Â²')}`;
                textHTML = `Square both sides to remove the root.`;
                break;
            case 2:
                mathHTML = `${n}${b}Â² &nbsp;=&nbsp; ${a}Â²`;
                textHTML = `Rearrange the equation: Multiply both sides by ${b}Â².`;
                break;
            case 3:
                mathHTML = `${n}${b}Â² &nbsp;=&nbsp; <span class="cube cube-a highlight-box">aÂ²</span>`;
                textHTML = `Notice that ${a}Â² is equal to ${n} times something. This means ${a}Â² is divisible by ${n}.`;
                break;
            case 4:
                mathHTML = `<span class="cube cube-a highlight-box">a</span> is divisible by ${n}`;
                textHTML = `Since ${n} is square-free, if it divides ${a}Â², it <strong>must</strong> divide ${a}.`;
                break;
            case 5:
                mathHTML = `${a} &nbsp;âž¡&nbsp; ${n}${c}`;
                textHTML = `Since ${a} is a multiple of ${n}, we can rewrite it as ${n} times some integer ${c}.`;
                if(state.step === 5) AudioSys.success();
                break;
            case 6:
                mathHTML = `${n}${b}Â² &nbsp;=&nbsp; (${n}${c})Â²`;
                textHTML = `Substitute this new value of ${a} back into our equation from step 2.`;
                break;
            case 7:
                mathHTML = `${n}${b}Â² &nbsp;=&nbsp; ${n*n}${c}Â²`;
                textHTML = `Expand the right side: (${n})Â² becomes ${n*n}.`;
                break;
            case 8:
                mathHTML = `${b}Â² &nbsp;=&nbsp; ${n}${c}Â²`;
                textHTML = `Divide both sides by ${n}.`;
                break;
            case 9:
                mathHTML = `<span class="cube cube-b highlight-box">bÂ²</span> &nbsp;=&nbsp; ${n}${c}Â²`;
                textHTML = `Now look at ${b}Â². It is also equal to ${n} times something. So ${b} is divisible by ${n}!`;
                break;
            case 10:
                mathHTML = `<div>${a} is div by ${n}</div> <div style="color:#ef4444; margin-left:10px;">AND</div> <div>${b} is div by ${n}</div>`;
                textHTML = `<strong>CONTRADICTION!</strong> We started by assuming ${a} and ${b} had NO common factors. But we proved they both share ${n}.<br><br>Therefore, âˆš${n} cannot be rational.`;
                isConclusion = true;
                
                dom.lock.className = 'lock-badge broken';
                dom.lock.innerHTML = 'ðŸ”“ BROKEN!';
                dom.nextBtn.disabled = true;
                dom.nextBtn.innerHTML = "Proof Complete";
                AudioSys.error();
                break;
        }

        // Create Card
        const card = document.createElement('div');
        card.className = `step-card active ${isConclusion ? 'conclusion' : ''}`;
        card.innerHTML = `
            <div class="step-header">Step ${state.step + 1}</div>
            <div class="step-math">${mathHTML}</div>
            <div class="step-explanation">${textHTML}</div>
        `;

        dom.container.appendChild(card);
        dom.bar.style.width = `${(state.step / STEPS_TOTAL) * 100}%`;

        // Smooth Scroll to bottom using RequestAnimationFrame to ensure rendering is done
        requestAnimationFrame(() => {
            dom.feed.scrollTop = dom.feed.scrollHeight;
        });
    }

    // Initialize
    validateAndReset();

</script>
</body>
</html>
